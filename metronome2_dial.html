<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Metronome â€” Dial</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111827;
      --panel-2: #1f2937;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #10b981; /* teal */
      --accent-2: #60a5fa; /* blue */
      --danger: #ef4444;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 70% 0%, #0d1b2a 0%, var(--bg) 40%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    .container {
      max-width: 820px;
      margin: 0 auto;
      padding: 1rem;
      display: grid;
      gap: 1rem;
    }
    header {
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap;
    }
    h1 { font-size: 1.25rem; margin: 0; }
    .sub { color: var(--muted); font-size: 0.9rem; }

    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 1rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    /* Grid layout: dial + controls */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    @media (min-width: 720px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }

    /* Dial block */
    .dial-wrap { display: grid; place-items: center; gap: 0.5rem; }
    .bpm-readout { font-size: 1.65rem; font-weight: 700; }
    .dial { touch-action: none; }
    .dial-svg { user-select: none; -webkit-user-drag: none; }

    .row { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
    .btn {
      padding: 0.6rem 0.85rem;
      border-radius: 12px;
      border: 1px solid #374151;
      background: #0f172a;
      color: var(--text);
      min-width: 3rem;
      cursor: pointer;
    }
    .btn:active { background: #0b1625; }
    .btn.primary { border-color: var(--accent); background: #062a23; }
    .btn.stop { border-color: var(--danger); background: #2a0d0d; }

    label { color: var(--muted); font-size: 0.9rem; }
    input[type="range"] { width: 180px; }
    input[type="number"] {
      width: 5rem; padding: 0.4rem 0.5rem; background: #0f172a; color: var(--text);
      border: 1px solid #374151; border-radius: 10px;
    }

    /* Beats bar */
    .beats-bar { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .beat-chip {
      width: 36px; height: 36px; border-radius: 10px; display: grid; place-items: center;
      background: #0f172a; border: 1px solid #374151; color: var(--muted); cursor: pointer;
      user-select: none;
    }
    .beat-chip.accent { color: var(--text); border-color: var(--accent); box-shadow: inset 0 0 0 2px var(--accent); }
    .beat-chip.active { outline: 3px solid var(--accent-2); }

    .sr-only { position: absolute; width:1px; height:1px; margin:-1px; padding:0; overflow:hidden; clip:rect(0,0,0,0); border:0; white-space:nowrap; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸŽµ Web Metronome</h1>
      <div class="sub">Touch-friendly dial, accents, and audio scheduling</div>
    </header>

    <section class="card grid" aria-label="Metronome controls">
      <!-- Left: Dial -->
      <div class="dial-wrap">
        <div
          class="dial"
          id="tempoDial"
          role="slider"
          aria-label="Tempo"
          aria-valuemin="40"
          aria-valuemax="208"
          aria-valuenow="120"
          tabindex="0"
        >
          <svg class="dial-svg" viewBox="0 0 120 120" width="200" height="200">
            <circle cx="60" cy="60" r="52" fill="#111827" stroke="#374151" stroke-width="4" />
            <g id="tickGroup"></g>
            <g id="needle" transform="rotate(-135 60 60)">
              <line x1="60" y1="60" x2="60" y2="14" stroke="var(--accent)" stroke-width="4" stroke-linecap="round"/>
              <circle cx="60" cy="60" r="7" fill="var(--accent)"/>
            </g>
          </svg>
          <div class="bpm-readout"><span id="bpmValue">120</span> BPM</div>
        </div>
        <div class="row">
          <button class="btn" id="minus5" aria-label="Decrease tempo by 5">âˆ’5</button>
          <button class="btn" id="minus1" aria-label="Decrease tempo by 1">âˆ’1</button>
          <button class="btn" id="tapTempo" aria-label="Tap tempo">Tap</button>
          <button class="btn" id="plus1" aria-label="Increase tempo by 1">+1</button>
          <button class="btn" id="plus5" aria-label="Increase tempo by 5">+5</button>
        </div>
      </div>

      <!-- Right: Transport & measure controls -->
      <div class="controls">
        <div class="row" style="margin-bottom:0.5rem">
          <button class="btn primary" id="startBtn" aria-label="Start metronome">Start</button>
          <button class="btn stop" id="stopBtn" aria-label="Stop metronome">Stop</button>
        </div>
        <div class="row" style="margin-bottom:0.5rem">
          <label for="beatsInput">Beats Per Measure</label>
          <input id="beatsInput" type="number" min="1" max="20" step="1" value="4" />
        </div>
        <div class="row" style="margin-bottom:0.75rem">
          <label for="volume">Volume</label>
          <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8" />
        </div>
        <div>
          <label>Click beats to toggle accent:</label>
          <div class="beats-bar" id="beatsBar" aria-label="Accent editor"></div>
        </div>
      </div>
    </section>

    <footer class="sub">Tap tempo averages recent taps â€¢ Hold +/- to auto-repeat â€¢ Designed for mobile</footer>
  </div>

  <script>
    // ===== Tempo Dial Config =====
    const MIN_BPM = 40;
    const MAX_BPM = 208;
    const START_BPM = 120;
    const MIN_DEG = -135;
    const MAX_DEG = 135;
    const COMMONS = [60, 72, 84, 90, 96, 100, 108, 112, 120, 126, 132, 144, 160, 180];
    const SNAP_THRESHOLD = 2;

    const dialEl = document.getElementById('tempoDial');
    const needleEl = document.getElementById('needle');
    const tickGroup = document.getElementById('tickGroup');
    const bpmValue = document.getElementById('bpmValue');
    const minus5 = document.getElementById('minus5');
    const minus1 = document.getElementById('minus1');
    const plus1 = document.getElementById('plus1');
    const plus5 = document.getElementById('plus5');
    const tapTempo = document.getElementById('tapTempo');

    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const bpmToDeg = (bpm) => {
      const t = (bpm - MIN_BPM) / (MAX_BPM - MIN_BPM);
      return MIN_DEG + t * (MAX_DEG - MIN_DEG);
    };
    const degToBpm = (deg) => {
      const t = (deg - MIN_DEG) / (MAX_DEG - MIN_DEG);
      return Math.round(MIN_BPM + t * (MAX_BPM - MIN_BPM));
    };

    const drawTicks = () => {
      const svgNS = 'http://www.w3.org/2000/svg';
      tickGroup.innerHTML = '';
      for (let bpm = MIN_BPM; bpm <= MAX_BPM; bpm += 5) {
        const deg = bpmToDeg(bpm);
        const rad = (Math.PI / 180) * deg;
        const cx = 60, cy = 60;
        const outerR = 52, innerR = bpm % 10 === 0 ? 40 : 46;
        const x1 = cx + innerR * Math.cos(rad);
        const y1 = cy + innerR * Math.sin(rad);
        const x2 = cx + outerR * Math.cos(rad);
        const y2 = cy + outerR * Math.sin(rad);
        const line = document.createElementNS(svgNS, 'line');
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
        line.setAttribute('stroke', bpm % 10 === 0 ? '#d1d5db' : '#9ca3af');
        line.setAttribute('stroke-width', bpm % 10 === 0 ? '2' : '1.25');
        tickGroup.appendChild(line);
        if (bpm % 20 === 0) {
          const label = document.createElementNS(svgNS, 'text');
          const lr = 33;
          const lx = cx + lr * Math.cos(rad);
          const ly = cy + lr * Math.sin(rad) + 4;
          label.setAttribute('x', lx);
          label.setAttribute('y', ly);
          label.setAttribute('fill', '#e5e7eb');
          label.setAttribute('font-size', '8');
          label.setAttribute('text-anchor', 'middle');
          label.textContent = bpm;
          tickGroup.appendChild(label);
        }
      }
    };

    let bpm = START_BPM;
    let dragging = false;
    const maybeSnap = (value) => {
      for (const c of COMMONS) if (Math.abs(value - c) <= SNAP_THRESHOLD) return c;
      return value;
    };
    const renderDial = () => {
      const deg = bpmToDeg(bpm);
      needleEl.setAttribute('transform', `rotate(${deg} 60 60)`);
      bpmValue.textContent = bpm;
      dialEl.setAttribute('aria-valuenow', String(bpm));
    };
    const emitTempoChange = () => {
      window.dispatchEvent(new CustomEvent('tempochange', { detail: { bpm } }));
    };
    const setBpm = (next, { silent = false } = {}) => {
      bpm = clamp(maybeSnap(Math.round(next)), MIN_BPM, MAX_BPM);
      renderDial();
      if (!silent) emitTempoChange();
    };
    const getCenter = (el) => { const r = el.getBoundingClientRect(); return { x: r.left + r.width/2, y: r.top + r.height/2 }; };
    const handlePointer = (x, y) => {
      const { x: cx, y: cy } = getCenter(dialEl.querySelector('.dial-svg'));
      const dx = x - cx, dy = y - cy;
      let deg = Math.atan2(dy, dx) * 180 / Math.PI;
      deg = clamp(deg, MIN_DEG, MAX_DEG);
      setBpm(degToBpm(deg));
    };
    dialEl.addEventListener('pointerdown', (e) => { dragging = true; dialEl.setPointerCapture(e.pointerId); handlePointer(e.clientX, e.clientY); });
    dialEl.addEventListener('pointermove', (e) => { if (dragging) handlePointer(e.clientX, e.clientY); });
    dialEl.addEventListener('pointerup', (e) => { dragging = false; dialEl.releasePointerCapture?.(e.pointerId); });
    dialEl.addEventListener('pointercancel', () => dragging = false);
    dialEl.addEventListener('keydown', (e) => {
      switch (e.key) {
        case 'ArrowLeft': case 'ArrowDown': setBpm(bpm - 1); break;
        case 'ArrowRight': case 'ArrowUp': setBpm(bpm + 1); break;
        case 'PageDown': setBpm(bpm - 5); break;
        case 'PageUp': setBpm(bpm + 5); break;
        case 'Home': setBpm(MIN_BPM); break;
        case 'End': setBpm(MAX_BPM); break;
      }
    });
    // Buttons & long press
    const longPressNudge = (btn, delta) => {
      let t=null,i=null; const start=()=>{ setBpm(bpm+delta); t=setTimeout(()=>{ i=setInterval(()=>setBpm(bpm+delta), 60); }, 400); }; const stop=()=>{ clearTimeout(t); clearInterval(i); t=i=null; };
      btn.addEventListener('pointerdown', start); btn.addEventListener('pointerup', stop); btn.addEventListener('pointerleave', stop); btn.addEventListener('pointercancel', stop);
    };
    minus5.addEventListener('click', () => setBpm(bpm - 5));
    minus1.addEventListener('click', () => setBpm(bpm - 1));
    plus1.addEventListener('click', () => setBpm(bpm + 1));
    plus5.addEventListener('click', () => setBpm(bpm + 5));
    longPressNudge(minus1, -1); longPressNudge(plus1, +1); longPressNudge(minus5, -5); longPressNudge(plus5, +5);
    const taps = []; const TAP_WINDOW_MS = 3500;
    tapTempo.addEventListener('click', () => {
      const now = performance.now();
      while (taps.length && now - taps[0] > TAP_WINDOW_MS) taps.shift();
      taps.push(now);
      if (taps.length >= 2) {
        let sum=0,c=0; for (let i=1;i<taps.length;i++){ const dt=taps[i]-taps[i-1]; if(dt>100&&dt<2000){sum+=dt;c++;} }
        if(c>=1){ const avgMs=sum/c; const next=Math.round(60000/avgMs); setBpm(next); }
      }
    });

    drawTicks();
    setBpm(START_BPM, { silent: true });
    emitTempoChange();

    // ===== Metronome engine (Web Audio with lookahead scheduler) =====
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const beatsInput = document.getElementById('beatsInput');
    const beatsBar = document.getElementById('beatsBar');
    const volume = document.getElementById('volume');

    let audioCtx = null, masterGain = null;
    let isPlaying = false;
    let currentBeat = 0; // 0-indexed
    let accentPattern = [1,0,0,0]; // 1 = accent, 0 = normal

    const LOOKAHEAD_MS = 25; // scheduler interval
    const SCHEDULE_AHEAD_S = 0.12; // how far ahead to schedule in seconds
    let nextNoteTime = 0; // AudioContext time for next beat
    let timerID = null;

    const rebuildBeatsBar = () => {
      beatsBar.innerHTML = '';
      for (let i = 0; i < accentPattern.length; i++) {
        const chip = document.createElement('button');
        chip.className = 'beat-chip' + (accentPattern[i] ? ' accent' : '');
        chip.textContent = String(i+1);
        chip.setAttribute('aria-label', `Beat ${i+1} ${accentPattern[i] ? 'accented' : 'unaccented'}`);
        chip.addEventListener('click', () => {
          accentPattern[i] = accentPattern[i] ? 0 : 1;
          chip.classList.toggle('accent');
        });
        beatsBar.appendChild(chip);
      }
    };

    const initAudio = () => {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = parseFloat(volume.value);
        masterGain.connect(audioCtx.destination);
      }
    };

    const scheduleClick = (time, isAccent) => {
      // Create a percussive click; accent uses a bell-like tone per Daniel's preference
      const gain = audioCtx.createGain();
      gain.connect(masterGain);

      // Envelope
      gain.gain.setValueAtTime(0.0001, time);
      gain.gain.exponentialRampToValueAtTime(isAccent ? 1.0 : 0.7, time + 0.005);
      gain.gain.exponentialRampToValueAtTime(0.0001, time + (isAccent ? 0.25 : 0.12));

      if (isAccent) {
        // Layered oscillators for a bell-like chime
        const osc1 = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        osc1.type = 'sine'; osc2.type = 'sine';
        osc1.frequency.setValueAtTime(880, time); // A5
        osc2.frequency.setValueAtTime(1320, time); // E6 harmonic
        osc1.connect(gain); osc2.connect(gain);
        osc1.start(time); osc2.start(time);
        osc1.stop(time + 0.25); osc2.stop(time + 0.25);
      } else {
        // Short, neutral click
        const osc = audioCtx.createOscillator();
        osc.type = 'square';
        osc.frequency.setValueAtTime(1200, time);
        osc.connect(gain);
        osc.start(time);
        osc.stop(time + 0.08);
      }

      // Visual: flash active beat exactly at 'time'
      const delayMs = Math.max(0, (time - audioCtx.currentTime) * 1000);
      const beatIndex = currentBeat; // capture
      setTimeout(() => {
        const chips = beatsBar.children;
        for (let i=0;i<chips.length;i++) chips[i].classList.toggle('active', i === beatIndex);
      }, delayMs);
    };

    const advanceNote = () => {
      currentBeat = (currentBeat + 1) % accentPattern.length;
      nextNoteTime += 60 / bpm;
    };

    const scheduler = () => {
      if (!isPlaying) return;
      while (nextNoteTime < audioCtx.currentTime + SCHEDULE_AHEAD_S) {
        const isAccent = !!accentPattern[currentBeat];
        scheduleClick(nextNoteTime, isAccent);
        advanceNote();
      }
      timerID = setTimeout(scheduler, LOOKAHEAD_MS);
    };

    const start = async () => {
      initAudio();
      await audioCtx.resume();
      isPlaying = true;
      currentBeat = 0;
      nextNoteTime = audioCtx.currentTime + 0.07;
      scheduler();
    };
    const stop = () => {
      isPlaying = false;
      if (timerID) { clearTimeout(timerID); timerID = null; }
      // Clear active UI
      const chips = beatsBar.children; for (let i=0;i<chips.length;i++) chips[i].classList.remove('active');
    };

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);

    beatsInput.addEventListener('change', (e) => {
      let n = clamp(parseInt(e.target.value || '4', 10), 1, 20);
      e.target.value = String(n);
      const old = accentPattern.slice(0);
      accentPattern = Array.from({ length: n }, (_, i) => (i === 0 ? 1 : (old[i] || 0)));
      rebuildBeatsBar();
      currentBeat = 0;
      if (isPlaying) { nextNoteTime = audioCtx.currentTime + 0.07; }
    });

    volume.addEventListener('input', (e) => { if (masterGain) masterGain.gain.value = parseFloat(e.target.value); });

    // React to tempo dial changes
    window.addEventListener('tempochange', (e) => {
      bpm = e.detail.bpm;
      if (isPlaying && audioCtx) { nextNoteTime = audioCtx.currentTime + 0.07; }
    });

    // Initial UI build
    rebuildBeatsBar();
  </script>
</body>
</html>
